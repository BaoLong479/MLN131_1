<div class="flex-1 flex flex-col h-full">
  <!-- Header -->
  <header class="p-3 sm:p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0 flex-wrap gap-2">
    <div class="flex items-center gap-2 sm:gap-4 flex-1">
       <div class="flex-1 min-w-0">
          <h2 class="text-base sm:text-xl font-bold text-red-700 truncate">{{ title() }}</h2>
          @if (state() === 'active') {
            <p class="text-xs sm:text-sm text-gray-500">Câu hỏi {{ currentQuestionIndex() + 1 }} / {{ questions().length }}</p>
          }
       </div>
        <button (click)="restartQuiz()" class="text-xs sm:text-sm bg-gray-200 text-gray-700 font-semibold px-2 sm:px-3 py-1 rounded-md hover:bg-gray-300 transition-colors flex items-center gap-1 flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 sm:h-4 sm:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 12A8 8 0 1013 5.26" />
          </svg>
          <span class="hidden sm:inline">Làm lại</span>
        </button>
    </div>
    <button (click)="quizClosed.emit()" class="text-gray-400 hover:text-gray-700 transition-colors flex-shrink-0">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-7 sm:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </button>
  </header>

  <!-- Progress Bar -->
  <div class="w-full bg-gray-200 h-2 flex-shrink-0">
    <div class="bg-red-600 h-2" [style.width.%]="progress()"></div>
  </div>

  <!-- Content -->
  <div class="flex-1 p-4 sm:p-6 overflow-y-auto bg-gray-50">
    @switch (state()) {
      @case ('finished') {
        <div class="flex flex-col items-center text-center max-w-md mx-auto px-4">
          <h3 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Hoàn thành!</h3>
          <p class="text-lg sm:text-xl text-gray-600 mb-4 sm:mb-6">Điểm số của bạn:</p>
          <div class="w-28 h-28 sm:w-32 sm:h-32 rounded-full flex items-center justify-center mb-6 sm:mb-8" [class.bg-green-100]="scorePercentage() >= 50" [class.bg-red-100]="scorePercentage() < 50" [class.text-green-600]="scorePercentage() >= 50" [class.text-red-600]="scorePercentage() < 50">
            <span class="text-3xl sm:text-4xl font-bold">{{ score() }}</span>
            <span class="text-xl sm:text-2xl font-medium">/{{ questions().length }}</span>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 w-full sm:w-auto">
             <button (click)="quizClosed.emit()" class="bg-gray-500 text-white font-semibold px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-gray-600 transition-colors">
              Chọn bài khác
            </button>
            <button (click)="restartQuiz()" class="bg-red-600 text-white font-semibold px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:bg-red-700 transition-colors">
              Làm lại
            </button>
          </div>
        </div>
      }
      @case ('active') {
        @if (currentQuestion(); as q) {
          <div>
            @switch (q.type) {
              @case ('multiple-choice') {
                <p class="text-base sm:text-xl font-medium text-gray-800 mb-4 sm:mb-6">{{ q.question }}</p>
                <div class="space-y-2 sm:space-y-3">
                  @for(option of q.options; track $index) {
                    @let isChecked = userAnswers()[currentQuestionIndex()] === option;
                    @let isCorrectAnswer = q.correctAnswer === option;
                    @let answerShown = checkedAnswers()[currentQuestionIndex()];
                    <label
                      class="w-full text-left p-3 sm:p-4 border rounded-lg transition-all text-gray-700 flex items-center cursor-pointer text-sm sm:text-base"
                      [class.hover:bg-red-50]="!answerShown"
                      [class.border-gray-300]="!isChecked"
                      [class.bg-red-100]="isChecked && !answerShown"
                      [class.border-red-400]="isChecked && !answerShown"
                      [class.font-semibold]="isChecked"
                      [class.cursor-not-allowed]="answerShown"
                      [class.bg-green-100]="answerShown && isCorrectAnswer"
                      [class.border-green-500]="answerShown && isCorrectAnswer"
                      [class.bg-red-100]="answerShown && !isCorrectAnswer && isChecked"
                      [class.border-red-500]="answerShown && !isCorrectAnswer && isChecked"
                      >
                      <input type="radio"
                            name="option-{{currentQuestionIndex()}}"
                            [value]="option"
                            [checked]="isChecked"
                            (change)="selectAnswer(option)"
                            [disabled]="answerShown"
                            class="mr-3 sm:mr-4 h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500 disabled:cursor-not-allowed flex-shrink-0">
                      <span class="font-mono mr-2 flex-shrink-0">{{ ['A', 'B', 'C', 'D'][$index] }}.</span>
                      <span class="flex-1">{{ option }}</span>
                    </label>
                  }
                </div>
              }
              @case ('matching') {
                 <div>
                    <p class="text-base sm:text-xl font-medium text-gray-800 mb-4 sm:mb-6">{{ q.question }}</p>
                    <div class="space-y-3 sm:space-y-4">
                      @for(term of matchingTerms(); track $index; let i = $index) {
                        @let answerShown = checkedAnswers()[currentQuestionIndex()];
                        @let isCorrectMatch = answerShown && (userAnswers()[currentQuestionIndex()] || [])[i] === q.pairs[i]?.definition;
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4 items-center">
                          <div class="p-2 sm:p-3 bg-white border rounded-md h-full flex items-center justify-center text-center font-semibold text-gray-700 text-sm sm:text-base">
                            {{ term }}
                          </div>
                          <select
                            class="w-full p-2 sm:p-3 border rounded-md h-full focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm sm:text-base"
                            [class.bg-green-100]="isCorrectMatch"
                            [class.border-green-500]="isCorrectMatch"
                            [class.bg-red-100]="answerShown && !isCorrectMatch"
                            [class.border-red-500]="answerShown && !isCorrectMatch"
                            [disabled]="answerShown"
                            (change)="selectMatchingAnswer(i, $event)">
                            <option value="">-- Chọn định nghĩa --</option>
                            @for(def of matchingShuffledDefinitions(); track $index) {
                               <option [value]="def.definition" [selected]="(userAnswers()[currentQuestionIndex()] || [])[i] === def.definition">{{ def.definition }}</option>
                            }
                          </select>
                        </div>
                      }
                    </div>
                  </div>
              }
            }

            <!-- Action Buttons -->
            <div class="mt-4 sm:mt-6">
              @if (!checkedAnswers()[currentQuestionIndex()]) {
                <button (click)="checkAnswer()" [disabled]="userAnswers()[currentQuestionIndex()] === null" class="bg-blue-600 text-white font-semibold px-4 sm:px-5 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm sm:text-base">
                  Kiểm tra đáp án
                </button>
              } @else {
                <div class="p-3 sm:p-4 rounded-lg" [class.bg-green-50]="isCorrect()[currentQuestionIndex()]" [class.bg-red-50]="!isCorrect()[currentQuestionIndex()]">
                  <p class="font-semibold text-sm sm:text-base" [class.text-green-800]="isCorrect()[currentQuestionIndex()]" [class.text-red-800]="!isCorrect()[currentQuestionIndex()]">
                    {{ isCorrect()[currentQuestionIndex()] ? 'Chính xác!' : 'Chưa chính xác.' }}
                    @if (q.type === 'multiple-choice' && !isCorrect()[currentQuestionIndex()]) {
                       <span class="font-normal block sm:inline mt-1 sm:mt-0">Đáp án đúng là: <strong>{{ q.correctAnswer }}</strong></span>
                    }
                  </p>

                  @if (explanations()[currentQuestionIndex()]; as explanation) {
                    <div class="mt-3 text-sm border-t pt-3 chatbot-content">
                      <markdown [data]="explanation"></markdown>
                    </div>
                  } @else {
                     @if (isExplaining()[currentQuestionIndex()]) {
                        <div class="flex items-center gap-2 mt-3 text-sm text-gray-600">
                            <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Đang lấy giải thích...</span>
                        </div>
                     } @else {
                        <button (click)="getExplanation(currentQuestionIndex())" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                           </svg>
                           AI giải thích đáp án
                        </button>
                     }
                  }
                </div>
              }
            </div>

            <div class="mt-6 sm:mt-8 flex justify-between items-center gap-2">
                <button (click)="prevQuestion()" [disabled]="currentQuestionIndex() === 0" class="bg-gray-200 text-gray-700 font-semibold px-3 sm:px-5 py-2 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm sm:text-base">
                  <span class="hidden sm:inline">Câu trước</span>
                  <span class="sm:hidden">Trước</span>
                </button>
                <button (click)="nextQuestion()" class="bg-red-600 text-white font-semibold px-3 sm:px-5 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base">
                  <span class="hidden sm:inline">{{ currentQuestionIndex() + 1 < questions().length ? 'Câu tiếp theo' : 'Hoàn thành' }}</span>
                  <span class="sm:hidden">{{ currentQuestionIndex() + 1 < questions().length ? 'Tiếp' : 'Xong' }}</span>
                </button>
            </div>
          </div>
        }
      }
    }
  </div>

   <!-- Review Section -->
  @if(state() === 'finished') {
    <div class="p-4 sm:p-6 border-t border-gray-200 overflow-y-auto bg-white">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4">Xem lại đáp án</h3>
      <ul class="space-y-4 sm:space-y-6">
        @for(question of questions(); track $index; let i = $index) {
          <li class="p-3 sm:p-4 bg-gray-50 rounded-lg border">
            <p class="font-semibold text-gray-800 text-sm sm:text-base">{{ i + 1 }}. {{ question.question }}</p>

            @if(question.type === 'multiple-choice') {
              <div class="mt-3 space-y-2 text-sm">
                @for(option of question.options; track $index) {
                  <div
                    class="p-2 rounded flex items-start gap-2"
                    [class.bg-red-100]="userAnswers()[i] === option && option !== question.correctAnswer"
                    [class.text-red-800]="userAnswers()[i] === option && option !== question.correctAnswer"
                    [class.font-semibold]="userAnswers()[i] === option && option !== question.correctAnswer"
                    [class.bg-green-100]="option === question.correctAnswer"
                    [class.text-green-800]="option === question.correctAnswer"
                    [class.font-bold]="option === question.correctAnswer">
                    <span>
                      @if (userAnswers()[i] === option && option !== question.correctAnswer) {
                        &#10060; <!-- Cross mark -->
                      } @else if (option === question.correctAnswer) {
                        &#9989; <!-- Check mark -->
                      } @else {
                        <span class="opacity-0">&#9989;</span>
                      }
                    </span>
                    <span>{{ option }}</span>
                  </div>
                }
              </div>
            } @else if (question.type === 'matching') {
              <div class="mt-3 space-y-2 text-sm">
                @for(pair of question.pairs; track $index; let j = $index) {
                  @let userAnswerForPair = (userAnswers()[i] || [])[j];
                  <div class="p-2 rounded"
                      [class.bg-green-100]="userAnswerForPair === pair.definition"
                      [class.text-green-800]="userAnswerForPair === pair.definition"
                      [class.bg-red-100]="userAnswerForPair && userAnswerForPair !== pair.definition"
                      [class.text-red-800]="userAnswerForPair && userAnswerForPair !== pair.definition">

                      <p class="font-semibold flex items-center gap-2">
                        <span>
                          @if (userAnswerForPair === pair.definition) { &#9989; } @else { &#10060; }
                        </span>
                        <span>{{ pair.term }}</span>
                      </p>
                      <div class="pl-8 mt-1">
                          <p><strong>Đáp án đúng:</strong> {{ pair.definition }}</p>
                          @if (userAnswerForPair && userAnswerForPair !== pair.definition) {
                            <p><strong>Bạn chọn:</strong> {{ userAnswerForPair }}</p>
                          } @else if (!userAnswerForPair) {
                            <p><strong>Bạn chọn:</strong> (Chưa trả lời)</p>
                          }
                      </div>
                  </div>
                }
              </div>
            }
          </li>
        }
      </ul>
    </div>
  }
</div>
